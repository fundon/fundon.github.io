<!doctype html><html><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><title>Async-await on Rust</title><meta content="Learn, create, share, enjoy, and feel." name=description><link rel="shortcut icon" href=/favicon.ico><link href=https://unpkg.com/minireset.css@0.0.7/minireset.css rel=stylesheet><link href=https://unpkg.com/firacode@6.2.0/distr/fira_code.css rel=stylesheet><link href=https://fundon.viz.rs/index.css rel=stylesheet><link href=https://fundon.viz.rs/atom.xml rel=alternate title=RSS type=application/atom+xml><body><script async>function toggle() {
        let classList = document.querySelector('html').classList;
        if (classList.contains('dark-theme')) {
          classList.remove('dark-theme')
          classList.add('sepia-theme')
          localStorage.setItem('theme-mode', 'sepia')
        } else if (classList.contains('sepia-theme')) {
          classList.remove('sepia-theme')
          localStorage.removeItem('theme-mode')
        } else {
          classList.add('dark-theme')
          localStorage.setItem('theme-mode', 'dark')
        }
      }
      try {
        let mode = localStorage.getItem('theme-mode');
        if (mode) {
          document.querySelector('html').classList.add(`${mode}-theme`)
        }
      } catch (e) {}</script><nav class=navbar><div class=container><div class=navbar-brand><a class=logo href=https://fundon.viz.rs> <img - src=https://fundon.viz.rs/logo.png> </a></div><ul class=social><li><a href=https://github.com/fundon> <svg viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2-7-2"></path></svg> </a><li><a href=https://fosstodon.org/@fundon> <svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><g fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2><path d="M18.648 15.254C16.832 17.017 12 16.88 12 16.88a18.262 18.262 0 0 1-3.288-.256c1.127 1.985 4.12 2.81 8.982 2.475c-1.945 2.013-13.598 5.257-13.668-7.636L4 10.309c0-3.036.023-4.115 1.352-5.633C7.023 2.766 12 3.01 12 3.01s4.977-.243 6.648 1.667C19.977 6.195 20 7.274 20 10.31s-.456 4.074-1.352 4.944z"/><path d="M12 11.204V8.278C12 7.02 11.105 6 10 6S8 7.02 8 8.278V13m4-4.722C12 7.02 12.895 6 14 6s2 1.02 2 2.278V13"/></g></svg> </a><li><a href=https://twitter.com/_fundon> <svg viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z"></path></svg> </a><li><a href=https://fundon.viz.rs/tags/> <svg viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path><path d="M7 7h.01"></path></svg> </a><li><a href=https://fundon.viz.rs/atom.xml> <svg viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a><li><button class=toggle><span class=sun> <svg viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><circle cx=12 cy=12 r=4></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg> </span> <span class=moon> <svg viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M12 3a6.364 6.364 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg> </span> <span class=coffee> <svg viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M17 8h1a4 4 0 1 1 0 8h-1"></path><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"></path><line x1=6 x2=6 y1=2 y2=4></line><line x1=10 x2=10 y1=2 y2=4></line><line x1=14 x2=14 y1=2 y2=4></line></svg> </span></button></ul></div></nav><header class=header><div class=container><h1 class=header-title>Async-await on Rust</h1><div class=header-meta><span class=header-meta-author>Fangdun Tsai</span><time class=header-meta-date> December 4th, 2019 </time></div><ul class=header-meta-tags><li><a href=https://fundon.viz.rs/tags/async-await/>Async-await</a> <li><a href=https://fundon.viz.rs/tags/rust/>Rust</a> <li><a href=https://fundon.viz.rs/tags/javascript/>JavaScript</a> <li><a href=https://fundon.viz.rs/tags/web/>Web</a> </ul></div></header><main class="content container"><article class=post><div class=post-content><p class=post-description>在异步世界中探索<p>异步操作，对 <strong>JavaScript</strong> 开发者来说已经属于日常操作，家常便饭。 从 <code>Callback</code> 到 <code>Promise</code> 再到 <code>Async-await</code>，一路摆脱了 <code>Callback Hell</code>、<code>Promise Chain</code>， <code>Async-await</code> 为工程开发带来了极大便利，简直是神兵利器。<p><strong>Rust</strong> 在 <strong><a href=https://blog.rust-lang.org/2019/11/07/Rust-1.39.0.html>1.39.0</a></strong> 稳定版中引入了期待已久的 <code>Async-await</code> 语法糖，这是一个伟大的里程碑，🦀 终于可以愉快地爬行了。<p>不管是 <strong>JavaScript</strong> 版本还是 <strong>Rust</strong> 版本，两则在设计上还是很多相似之处，可以探索一番。<h3 id=javascript>JavaScript</h3><ul><li><p><a href=https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/AsyncFunction>AsyncFunction</a>：用来创建新的异步函数对象</p><li><p><a href=https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise>Promise</a>：对象用于表示一个异步操作的最终完成 (或失败)，及其结果值</p> <ul><li><code>pending</code>：初始状态，既不是成功，也不是失败状态<li><code>fulfilled</code>：意味着操作成功完成<li><code>rejected</code>：意味着操作失败</ul></ul><p>可以通过 <code>async function</code> 来声明一个 <code>AsyncFunction</code>，当执行这个 <code>AsyncFunction()</code> 时， 会返回一个 <code>Promise</code>，然后再执行 <code>await Promise</code> 操作，经过计算后，就可以获得最终结果。<pre class="language-js z-code" data-lang=js><code class=language-js data-lang=js><span class="z-source z-ts"><span class="z-meta z-function z-ts"><span class="z-storage z-modifier z-async z-ts">async</span> <span class="z-storage z-type z-function z-ts">function</span> <span class="z-meta z-definition z-function z-ts"><span class="z-entity z-name z-function z-ts">get</span></span><span class="z-meta z-parameters z-ts"><span class="z-punctuation z-definition z-parameters z-begin z-ts">(</span><span class="z-punctuation z-definition z-parameters z-end z-ts">)</span></span> <span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
  <span class="z-keyword z-control z-flow z-ts">return</span> <span class="z-string z-quoted z-single z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">'</span>Hello Async-await<span class="z-punctuation z-definition z-string z-end z-ts">'</span></span>
<span class="z-punctuation z-definition z-block z-ts">}</span></span></span>

<span class="z-meta z-function z-ts"><span class="z-storage z-modifier z-async z-ts">async</span> <span class="z-storage z-type z-function z-ts">function</span> <span class="z-meta z-definition z-function z-ts"><span class="z-entity z-name z-function z-ts">main</span></span><span class="z-meta z-parameters z-ts"><span class="z-punctuation z-definition z-parameters z-begin z-ts">(</span><span class="z-punctuation z-definition z-parameters z-end z-ts">)</span></span> <span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
  <span class="z-meta z-var z-expr z-ts"><span class="z-storage z-type z-ts">let</span> <span class="z-meta z-var-single-variable z-expr z-ts"><span class="z-meta z-definition z-variable z-ts"><span class="z-variable z-other z-readwrite z-ts">result</span></span> </span><span class="z-keyword z-operator z-assignment z-ts">=</span> <span class="z-keyword z-control z-flow z-ts">await</span> <span class="z-meta z-function-call z-ts"><span class="z-entity z-name z-function z-ts">get</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-brace z-round z-ts">)</span></span>
  <span class="z-meta z-function-call z-ts"><span class="z-support z-class z-console z-ts">console</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-support z-function z-console z-ts">log</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-variable z-other z-readwrite z-ts">result</span><span class="z-meta z-brace z-round z-ts">)</span>
<span class="z-punctuation z-definition z-block z-ts">}</span></span></span>

<span class="z-meta z-function-call z-ts"><span class="z-entity z-name z-function z-ts">main</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-brace z-round z-ts">)</span>
</span></code></pre><h3 id=rust>Rust</h3><ul><li><p><a href=https://doc.rust-lang.org/std/future/trait.Future.html>Future</a>：用来表示一个异步计算</p><li><p><a href=https://doc.rust-lang.org/beta/std/task/enum.Poll.html>Poll</a>：类似 <strong>JavaScript</strong> 中的 <code>Promise</code>，它是一个枚举类型 <code>Poll&LTT></code></p> <ul><li><code>Ready&LTT></code>：表示结果已经计算完毕，准备妥当，可以立刻返回<li><code>Pending</code>：等待状态，任务进行中，还在计算，结果准备中</ul></ul><p>可以通过 <code>async fn</code>，声明一个异步方法，当执行这个异步方法 <code>fn()</code> 时，会返回一个 <code>Future</code>，然后再执行 <code>Future.await</code> 操作， 创建一个新任务，此时内部真正执行的是 <code>Future.poll()</code>，它会返回一个 <code>Poll</code>，经过计算后，就可以获得最终结果。<h4 id=xiao-tie-shi>小贴士</h4><ul><li><p>如果一个异步方法有返回结果 <code>T</code>，则相应的，执行 <code>fn()</code> 时，返回的是 <code>Future&LTOutput = T></code>。</p><li><p>因为返回结果 <code>T</code> 是一个范型，可以在 <code>Future.await</code> 后面加上 <code>?</code> 操作符，<code>Future.await?</code>，它会把结果转化成 <code>Result&LTT, E></code>， 此时我们就可以轻松判断成功或失败，这就与 <strong>JavaScript</strong> 中的 <code>Promise#fulfilled</code> 和 <code>Promise#rejected</code> 异曲同工。</p></ul><pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">async_std<span class="z-punctuation z-accessor z-rust">::</span></span>task<span class="z-punctuation z-terminator z-rust">;</span>

async <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">get</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> String</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>Hello Async-await<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">to_owned</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

<span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-meta z-path z-rust">task<span class="z-punctuation z-accessor z-rust">::</span></span>block_on<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>async <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-storage z-type z-rust">let</span> result <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">get</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span><span class="z-constant z-other z-placeholder z-rust">{}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-separator z-rust">,</span> result<span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><h3 id=zong-jie>总结</h3><p>以上分析两种语言在 <code>Async-await</code> 的设计、执行流程，在实现上有很多相识之处，如果之前有 <strong>JavaScript</strong> 开发经验，则可以轻松地过渡到 <strong>Rust</strong> 中。<p>总之让我们 🦀 愉快地爬起来。</div></article></main><footer class=footer><div class=container><div class=heart><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a>  20114-PRESENT © Fangdun Tsai   <svg viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M20.42 4.58a5.4 5.4 0 0 0-7.65 0l-.77.78-.77-.78a5.4 5.4 0 0 0-7.65 0C1.46 6.7 1.33 10.28 4 13l8 8 8-8c2.67-2.72 2.54-6.3.42-8.42z"></path></svg></div><div class=power>Powered By <a href=https://www.getzola.org/>Zola</a> & <a href=https://vercel.com/design>Design</a></div></div></footer><script>document.querySelector('button.toggle').onclick = toggle</script>